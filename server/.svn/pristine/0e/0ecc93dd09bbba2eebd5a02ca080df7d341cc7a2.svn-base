package com.cheyooh.service.sdk.action.client;

import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.apache.commons.lang.StringUtils;

import com.cheyooh.service.dal.DAL;
import com.cheyooh.service.dal.DALFactory;
import com.cheyooh.service.framework.idata.Result;
import com.cheyooh.service.framework.idata.StatusCode;
import com.cheyooh.service.sdk.db.dao.SdkNotifySinaMonthlyMapper;
import com.cheyooh.service.sdk.db.dao.SdkOrderMapper;
import com.cheyooh.service.sdk.db.dao.SdkOrderMmdoMapper;
import com.cheyooh.service.sdk.db.dao.SdkOrderMmdoPayrepeatMapper;
import com.cheyooh.service.sdk.db.entity.SdkNotifySinaMonthly;
import com.cheyooh.service.sdk.db.entity.SdkNotifySinaMonthlyExample;
import com.cheyooh.service.sdk.db.entity.SdkOrder;
import com.cheyooh.service.sdk.db.entity.SdkOrderMmdo;
import com.cheyooh.service.sdk.db.entity.SdkOrderMmdoPayrepeat;
import com.cheyooh.service.sdk.idata.CmdPaybackMmdo;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;

public class Payback_mmdo extends AbstractSdkClientService<CmdPaybackMmdo> {
	private static final String SINA_MONTH_SMS = "sinamonthsms";
	private static final String CMCC_XYTF = "cmccxytf";
	private static final String WO_APPSTORE = "woappstore";
	private static final String CMCC49YOU = "cmcc49you";
	private static final String MOBILEGAMEBASEPM = "mobilegamebasepm";
	private static final String CUCCZHANGYUNZY = "cucczhangyunzy";
	private static final String SDKXQTPAY = "sdkxqtpay";
	private static final String DELIMITER = ",";
	private static final String CUCCYIJIANWOMUSIC = "cuccyijianwomusic";
	private static final String CMCCYONGZHENG = "cmccyongzheng";
//	private static final String SPLIT_CONTENT_STRING = Cfg.cfg.getString(
//			"mmdo_content_spilt", "#");
	
	private static final ObjectMapper mapper = new ObjectMapper();
	static {
		// mapper.setPropertyNamingStrategy(PropertyNamingStrategy.CAMEL_CASE_TO_LOWER_CASE_WITH_UNDERSCORES);
		mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,
				false);
	}

	@Override
	protected boolean isLoginRequired() {
		return true;
	}

	@Override
	protected Result execute(CmdPaybackMmdo cmd) {
		DAL dal = DALFactory.createDAL();
		try {
			String originalcode = cmd.getServiceContext().getRequest()
					.getParameter("originalcode");
			if (StringUtils.isEmpty(originalcode)
					|| StringUtils.isBlank(originalcode)) {
				originalcode = "";
			}

			SdkOrderMapper orderMapper = dal.getMapper(SdkOrderMapper.class);
			String orderNo = cmd.getOrder_no();

			// 处理沃商店订单号
			if (WO_APPSTORE.equals(cmd.getSms_type())) {
				orderNo = orderNo.substring(8);
			}

//			logger.debug("the pay back mmdo orderNo =" + orderNo + ", and originalcode ="
//					+ originalcode);

			// 处理在订单表找不到订单号
			SdkOrder order = orderMapper.selectByPrimaryKey(orderNo);
			if (order == null) {
				logger.error("the pay back mmdo error, can not found the order no : "
						+ cmd.getOrder_no());
				return StatusCode.SUCCESS();
			}
			SdkOrderMmdoMapper orderMmdoMapper = dal
					.getMapper(SdkOrderMmdoMapper.class);
			SdkOrderMmdo orderMmdo = orderMmdoMapper.selectByPrimaryKey(order
					.getPayId());
			if (orderMmdo == null) {
				logger.error("the pay back mmdo error, can not found the mmdo order id : "
						+ order.getPayId());
				return StatusCode.SUCCESS();
			}

			String smstype = orderMmdo.getPayChannelCode();
			// 处理短信重发机制判断state，只有有一个state状态为1即表明已经成功发送出去
			String[] stateRespArray = cmd.getState().split(DELIMITER);
			boolean isPaid = false;
			for (String state : stateRespArray) {
				if ("1".equals(state)) {
					stateRespArray[0] = "1";
					isPaid = true;
					break;
				}
			}

			// 记录订单详细信息
			orderMmdo.setRespSendNumber(cmd.getNumber());
			orderMmdo.setRespSendContent(cmd.getContent());
			orderMmdo.setRespImsi(cmd.getImsi());
			orderMmdo.setRespTime(new Date());
			if (SDKXQTPAY.equals(smstype)) {
				try {
					Map<String, String> jsonMap = mapper.readValue(
							originalcode,
							new TypeReference<HashMap<String, String>>() {
							});
					originalcode = jsonMap.get("errmsg");
				} catch (Exception e) {
					logger.error("the sdkxqtpay originalcode change to json error is :"
							+ e);
				}
			}
			order.setOriginalcode(originalcode);
			// 历史记录返回码
			SdkOrderMmdoPayrepeatMapper sdkOrderMmdoPayrepeatMapper=dal.getMapper(SdkOrderMmdoPayrepeatMapper.class);
		    SdkOrderMmdoPayrepeat sdkOrderMmdoPayrepeat=new SdkOrderMmdoPayrepeat();
		    sdkOrderMmdoPayrepeat.setOrderNo(order.getOrderNo());
		    sdkOrderMmdoPayrepeat.setOperationType(orderMmdo.getOperationType());
		    sdkOrderMmdoPayrepeat.setPayChannelCode(orderMmdo.getPayChannelCode());
		    sdkOrderMmdoPayrepeat.setCreatedTime(order.getCreateTime());
		    sdkOrderMmdoPayrepeat.setOriginalcode(originalcode);
		    sdkOrderMmdoPayrepeatMapper.insertSelective(sdkOrderMmdoPayrepeat);
			//

			logger.info("the payback_mmdo is : the orderNo =" + orderNo
					+ ", the pay id =" + orderMmdo.getPayId()
					+ ", the sdkOrderMmdo smstpye =" + cmd.getSms_type()
					+ ", the req sdkOrderMmdo state =" + cmd.getState()
					+ ", the last isPaid =" + isPaid
					+", and originalcode ="+originalcode);

			if (isPaid) {
				if (SINA_MONTH_SMS.equals(cmd.getSms_type())) {
					SdkNotifySinaMonthlyMapper monthlyMapper = dal
							.getMapper(SdkNotifySinaMonthlyMapper.class);
					SdkNotifySinaMonthlyExample example = new SdkNotifySinaMonthlyExample();
					example.createCriteria().andOrderNoEqualTo(
							order.getOrderNo());
					SdkNotifySinaMonthly monthly = monthlyMapper
							.selectOne(example);
					if (monthly != null && "2".equals(monthly.getSmsState())) {
						SinaMonthSms sinaMonthSms = new SinaMonthSms(order);
						sinaMonthSms.start();
					} else {
						orderMmdo.setRespStatus(1);
						order.setStatus(1);
						order.setStatusDetail("");
					}
				} else if (CMCC_XYTF.equals(cmd.getSms_type())) {
					logger.debug("the cmccXytfConfirmReq enter and sdkOrderMmdo is not null");
					CmccXytfConfirmReqThread cmccXytfConfirmReqThread = new CmccXytfConfirmReqThread(
							cmd.getOrder_no(), orderMmdo.getImei(),
							cmd.getImsi(), orderMmdo.getReqSendContent());
					cmccXytfConfirmReqThread.start();
					orderMmdo.setRespStatus(1);
					order.setStatus(1);
					order.setStatusDetail("");
				} else if (CMCC49YOU.equals(smstype)
						|| MOBILEGAMEBASEPM.equals(smstype)
						|| CUCCZHANGYUNZY.equals(smstype)
						|| CUCCYIJIANWOMUSIC.equals(smstype)
						|| CMCCYONGZHENG.equals(smstype)
						) {
					orderMmdo.setRespStatus(1);
					order.setStatus(2);
					order.setStatusDetail("");
				} else {
					// 订单完成
					orderMmdo.setRespStatus(1);
					order.setStatus(1);
					order.setStatusDetail("");
				}
			} else {
				// 初始失败状态
				int orderstate = 3;
				String faildetail = "";
				if (originalcode.equals("leyosms1")) {
					// 未知原因错误，如拦截短信
					orderstate = 14;
					faildetail = "未知原因错误，如拦截短信";
				} else if (originalcode.equals("leyosms2")) {
					// 飞行模式
					orderstate = 15;
					faildetail = "飞行模式";
				} else if (originalcode.equals("leyosms3")) {
					// 长短信发送解析失败
					orderstate = 16;
					faildetail = "长短信发送解析失败";
				} else if (originalcode.equals("leyosms4")) {
					// 不在服务区
					orderstate = 17;
					faildetail = "不在服务区";
				} else if (originalcode.equals("leyosms-1000")) {
					// 超时，如余额不足
					orderstate = 18;
					faildetail = "超时，如余额不足";
				} else if (originalcode.equals("leyoordercancel")) {
					orderstate = 19;
					faildetail = "订单取消";
				}else if(originalcode.equals("leyosmsnull")){
					orderstate = 20;
					faildetail = "获取短信内容端口异常";
				}else if(originalcode.equals("leyo21")){
					orderstate = 21;
					faildetail = "获取验证码超时";
				}
				orderMmdo.setRespStatus(orderstate);
				order.setStatus(orderstate);
				order.setStatusDetail(faildetail);
				logger.error("the pay back mmdo error, orderNo =" + orderNo+", pay id ="+orderMmdo.getPayId());
				logger.error("pay back mmdo error, db req sms port = "
						+ orderMmdo.getReqSendNumber());
				logger.error("pay back mmdo error, db sms port = "
						+ orderMmdo.getRespSendNumber());
				logger.error("pay back mmdo error, receive sms port = "
						+ cmd.getNumber());
				logger.error("pay back mmdo error, receive sms content = "
						+ cmd.getContent());
				logger.error("pay back mmdo error, sms state = "
						+ cmd.getState());
			}
			orderMmdoMapper.updateByPrimaryKeySelective(orderMmdo);
			orderMapper.updateByPrimaryKeySelective(order);
			dal.commit();
		} finally {
			dal.close();
		}
		return StatusCode.SUCCESS();
	}

}
