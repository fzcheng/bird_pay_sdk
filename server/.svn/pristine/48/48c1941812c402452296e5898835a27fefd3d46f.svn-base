package com.cheyooh.service.sdk.action.notify;

import org.apache.commons.lang.StringUtils;

import com.cheyooh.service.dal.DAL;
import com.cheyooh.service.dal.DALFactory;
import com.cheyooh.service.framework.idata.Cmd;
import com.cheyooh.service.framework.idata.Result;
import com.cheyooh.service.framework.idata.ResultXJContent;
import com.cheyooh.service.sdk.db.dao.SdkNotifyMmdoMapper;
import com.cheyooh.service.sdk.db.dao.SdkTelephoneMapper;
import com.cheyooh.service.sdk.db.entity.SdkNotifyMmdo;
import com.cheyooh.service.sdk.db.entity.SdkNotifyMmdoExample;
import com.cheyooh.service.sdk.db.entity.SdkTelephone;
import com.cheyooh.service.sdk.db.entity.SdkTelephoneExample;


public class CtcclovemusicNotify extends AbstractNotifyService<Cmd> {
		private String msg="{\"description\":\"成功\",\"code\":\"0000\"}";
		/*
		 * (non-Javadoc)
		 * 
		 * @see
		 * com.cheyooh.service.framework.basic.Service#verify(com.cheyooh.service
		 * .framework.idata.Cmd)
		 */
		@Override
		protected Result verify(Cmd cmd) {
			return null;
		}

		/*
		 * (non-Javadoc)
		 * 
		 * @see
		 * com.cheyooh.service.framework.basic.Service#execute(com.cheyooh.service
		 * .framework.idata.Cmd)
		 */
		@Override
		protected Result execute(Cmd cmd) {
			DAL dal = DALFactory.createDAL();
			String resultMsg="";
			try {
				String mobileString = cmd.getServiceContext().getRequest()
						.getParameter("mobile");
				String mobile="";
				if(StringUtils.isNotBlank(mobileString)&&StringUtils.isNotEmpty(mobileString)){
					if(mobileString.contains("tel:")){
						mobile=mobileString.substring(4);
					}else {
						mobile=mobileString;
					}
				}
				
				String sms_order = cmd.getServiceContext().getRequest()
						.getParameter("sms_order");
				if(StringUtils.isEmpty(sms_order)){
					sms_order="";
				}
				String state = cmd.getServiceContext().getRequest()
						.getParameter("state");
				String orderNo="";
				if(StringUtils.isNotBlank(sms_order)&&StringUtils.isNotEmpty(sms_order)){
					orderNo=sms_order.substring(sms_order.length()-16,sms_order.length());
				}
				
				SdkNotifyMmdoMapper sdkNotifyMmdoMapper1=dal.getMapper(SdkNotifyMmdoMapper.class);
				SdkNotifyMmdoExample sdkNotifyMmdoExample1=new SdkNotifyMmdoExample();
				sdkNotifyMmdoExample1.createCriteria().andOrderNoEqualTo(orderNo);
				SdkNotifyMmdo sdkNotifyMmdo1=sdkNotifyMmdoMapper1.selectOne(sdkNotifyMmdoExample1);
				logger.info("the ctcclovemusic notify orderNo is: " + orderNo);
				
				if (sdkNotifyMmdo1 != null) {
					int notifyStatus=0;
					if("0".equals(state)){
						notifyStatus=1;
					}else {
						notifyStatus=0;
					}
					sdkNotifyMmdo1.setMobile(mobile);
					SdkTelephoneMapper sdkTelephoneMapper=dal.getMapper(SdkTelephoneMapper.class);
					SdkTelephoneExample sdkTelephoneExample=new SdkTelephoneExample();
					sdkTelephoneExample.createCriteria().andMobilephoneEqualTo(mobile);
					SdkTelephone sdkTelephone=sdkTelephoneMapper.selectOne(sdkTelephoneExample);
					if(sdkTelephone!=null){
						sdkNotifyMmdo1.setKey(String.valueOf(sdkTelephone.getProvinceNo()));
					}
					sdkNotifyMmdo1.setOriginalcode(state);
					sdkNotifyMmdo1.setNotifyStatus(notifyStatus);
					sdkNotifyMmdoMapper1.updateByPrimaryKey(sdkNotifyMmdo1);
					resultMsg=msg;
//					logger.info("the SdkNotifyMmdo is exist ! orderNo is :"+orderNo);
//					return response(msg);
				}else {
					resultMsg="fail";
				}
				
//				if("0".equals(state)){
//					SdkOrderMapper sdkOrderMapper = dal.getMapper(SdkOrderMapper.class);
//					SdkOrderExample sdkOrderExample = new SdkOrderExample();
//					sdkOrderExample.createCriteria().andOrderNoEqualTo(orderNo);
//					SdkOrder sdkOrder = sdkOrderMapper.selectOne(sdkOrderExample);
//					if (sdkOrder != null) {
//						SdkOrderMmdoMapper sdkOrderMmdoMapper = dal
//								.getMapper(SdkOrderMmdoMapper.class);
//						SdkOrderMmdoExample sdkOrderMmdoExample = new SdkOrderMmdoExample();
//						sdkOrderMmdoExample.createCriteria().andPayIdEqualTo(
//								sdkOrder.getPayId());
//						SdkOrderMmdo sdkOrderMmdo = sdkOrderMmdoMapper
//								.selectOne(sdkOrderMmdoExample);
//						if (sdkOrderMmdo != null) {
//							SdkNotifyMmdo sdkNotifyMmdo = new SdkNotifyMmdo();
//							sdkNotifyMmdo.setLinkid(orderNo);
//							sdkNotifyMmdo.setSpid(sdkOrderMmdo.getRespSendNumber());
//							sdkNotifyMmdo.setCmd(sdkOrderMmdo.getRespSendContent());
//							sdkNotifyMmdo.setMobile(mobile);
//							SdkTelephoneMapper sdkTelephoneMapper=dal.getMapper(SdkTelephoneMapper.class);
//							SdkTelephoneExample sdkTelephoneExample=new SdkTelephoneExample();
//							sdkTelephoneExample.createCriteria().andImsiEqualTo(sdkOrderMmdo.getRespImsi());
//							SdkTelephone sdkTelephone=sdkTelephoneMapper.selectOne(sdkTelephoneExample);
//							if(sdkTelephone!=null){
//								sdkNotifyMmdo.setKey(String.valueOf(sdkTelephone.getProvinceNo()));
//							}
//							sdkNotifyMmdo.setSpnum(sdkOrderMmdo.getReqSendNumber());
//							sdkNotifyMmdo.setGameId(sdkOrderMmdo.getGameId());
//							sdkNotifyMmdo.setAmount(sdkOrderMmdo.getReqOrderAmount());
//							sdkNotifyMmdo.setCreateTime(new Date());
//							sdkNotifyMmdo.setOperationType(3);
//							sdkNotifyMmdo.setPayChannelCode(sdkOrderMmdo
//									.getPayChannelCode());
//							sdkNotifyMmdo.setAdditionalStatus(sdkOrderMmdo.getAdditionalStatus());
//							sdkNotifyMmdo.setOrderNo(orderNo);
//							SdkNotifyMmdoMapper sdkNotifyMmdoMapper = dal
//									.getMapper(SdkNotifyMmdoMapper.class);
//							sdkNotifyMmdoMapper.insertSelective(sdkNotifyMmdo);
//						}
//					}
//				}
				dal.commit();
			} catch (Exception e) {
				logger.error("the ctcclovemusic notify error!", e);
			} finally {
				dal.close();
			}
			return response(resultMsg);
		}

		private Result response(String msg) {
			return new Result(new ResultXJContent(msg, msg));
		}
}
