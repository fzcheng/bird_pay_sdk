package com.cheyooh.service.sdk.action.notify;

import java.util.Date;

import com.cheyooh.service.dal.DAL;
import com.cheyooh.service.dal.DALFactory;
import com.cheyooh.service.framework.idata.Result;
import com.cheyooh.service.framework.idata.ResultXJContent;
import com.cheyooh.service.sdk.db.dao.SdkOrderMapper;
import com.cheyooh.service.sdk.db.dao.SdkOrderYeepayMapper;
import com.cheyooh.service.sdk.db.entity.SdkOrder;
import com.cheyooh.service.sdk.db.entity.SdkOrderYeepay;
import com.cheyooh.service.sdk.idata.notify.CmdYeepayOrder;
import com.yeepay.nonbankcard.NonBankcardService;


/**
 * 易宝支付通知
 * 
 * 
 * @author zhouzg@cheyooh.com
 *
 */
public class YeepayNotify extends AbstractNotifyService<CmdYeepayOrder>{

	@Override
	protected Result verify(CmdYeepayOrder cmd) {	
		try{
			NonBankcardService.verifyCallback(
					cmd.getR0_Cmd(), 
					""+cmd.getR1_Code(), 
					cmd.getP1_MerId(), 
					cmd.getP2_Order(), 
					""+cmd.getP3_Amt(), 
					cmd.getP4_FrpId(), 
					cmd.getP5_CardNo(), 
					cmd.getP6_confirmAmount(), 
					cmd.getP7_realAmount(), 
					cmd.getP8_cardStatus(), 
					cmd.getP9_MP(), 
					cmd.getPb_BalanceAmt(), 
					cmd.getPc_BalanceAct(), 
					cmd.getHmac());
		}catch(Exception e){
			return fail(cmd,"fail: "+e.getMessage());
		}
		return null;
	}

	@Override
	protected Result execute(CmdYeepayOrder cmd) {
		DAL dal=DALFactory.createDAL();
		try{
			SdkOrderYeepayMapper mapper_yeepay=dal.getMapper(SdkOrderYeepayMapper.class);
			SdkOrderMapper mapper_order=dal.getMapper(SdkOrderMapper.class);
			
			SdkOrder order=mapper_order.selectByPrimaryKey(cmd.getP2_Order());
			if(order!=null){ 			
				SdkOrderYeepay yeepay=mapper_yeepay.selectByPrimaryKey(order.getPayId());
				if(yeepay!=null){					
					setupOrderStatus(cmd,order,yeepay);
					
					mapper_yeepay.updateByPrimaryKeySelective(yeepay);
					mapper_order.updateByPrimaryKeySelective(order);
					dal.commit();
					
					NotifyOrder.doNotify(order);
					
					logger.info("Paid status: "+order.getStatus()+"("+yeepay.getNotifyR1Code()+"), payid: "+order.getPayId());
					
 					return success();
				}else{
					return fail(cmd,"fail: OrderPay not exists: "+order.getPayId());
				}
			}else{
				return fail(cmd,"fail: OrderNo not exists: "+cmd.getP2_Order());
			}
		}catch(Exception e){
			logger.error(e);
			
			return fail(cmd,"Exception: "+e.getMessage()+", class: ".getClass());
		}finally{
			dal.close();
		}
	}
		
	private void setupOrderStatus(CmdYeepayOrder cmd,SdkOrder order,SdkOrderYeepay yeepay){
		yeepay.setNotifyTime(new Date());
		yeepay.setNotifyP3Amt(cmd.getP3_Amt());
		yeepay.setNotifyP4Frpid(cmd.getP4_FrpId());
		yeepay.setNotifyP5Cardno(cmd.getP5_CardNo());
		yeepay.setNotifyP6Confirmamount(cmd.getP6_confirmAmount());
		yeepay.setNotifyP7Realamount(cmd.getP7_realAmount());
		yeepay.setNotifyP8Cardstatus(cmd.getP8_cardStatus());
		yeepay.setNotifyP9Mp(cmd.getP9_MP());
		yeepay.setNotifyPbBalanceamt(cmd.getPb_BalanceAmt());
		yeepay.setNotifyPcBalanceact(cmd.getPc_BalanceAct());
		yeepay.setNotifyR1Code(cmd.getR1_Code()); 
		
		
		order.setCompleteTime(yeepay.getNotifyTime());
		if(yeepay.getNotifyR1Code()==1){ 
			//订单成功
			order.setStatus(1);			 
		}else{
			//订单失败
			order.setStatus(3);
			
			order.setStatusDetail("YEE."+yeepay.getNotifyP8Cardstatus());
		}
	}
	
	private Result success(){
		return new Result(new ResultXJContent("success","success"));
	}
	
	private Result fail(CmdYeepayOrder cmd,String msg){
		//log
		return new Result(new ResultXJContent(msg,msg));
	}

}
