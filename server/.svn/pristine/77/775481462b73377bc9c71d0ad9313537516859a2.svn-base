package com.cheyooh.service.sdk.action.notify;

import java.util.Date;

import org.apache.commons.lang.StringUtils;

import com.cheyooh.service.dal.DAL;
import com.cheyooh.service.dal.DALFactory;
import com.cheyooh.service.framework.idata.Cmd;
import com.cheyooh.service.framework.idata.Result;
import com.cheyooh.service.framework.idata.ResultXJContent;
import com.cheyooh.service.sdk.db.dao.SdkNotifyMmdoMapper;
import com.cheyooh.service.sdk.db.entity.SdkNotifyMmdo;


public class XingtianyuanNotify extends AbstractNotifyService<Cmd> {
	private String payChannelCode="cmccxingtianyuansms";
	private String resultMsg="";
	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.cheyooh.service.framework.basic.Service#verify(com.cheyooh.service
	 * .framework.idata.Cmd)
	 */
	@Override
	protected Result verify(Cmd cmd) {
		return null;
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.cheyooh.service.framework.basic.Service#execute(com.cheyooh.service
	 * .framework.idata.Cmd)
	 */
	@Override
	protected Result execute(Cmd cmd) {
		DAL dal = DALFactory.createDAL();
		try {
			String linkid = cmd.getServiceContext().getRequest()
					.getParameter("linkid");
			if(StringUtils.isEmpty(linkid)){
				linkid="";
			}
			String spnumber = cmd.getServiceContext().getRequest()
					.getParameter("spnumber");
			if(StringUtils.isEmpty(spnumber)){
				spnumber="";
			}
			String momsg = cmd.getServiceContext().getRequest()
					.getParameter("momsg");
			if(StringUtils.isEmpty(momsg)){
				momsg="";
			}
			String mobile = cmd.getServiceContext().getRequest()
					.getParameter("mobile");
			if(StringUtils.isEmpty(mobile)){
				mobile="";
			}
			String province = cmd.getServiceContext().getRequest()
					.getParameter("province");
			if(StringUtils.isEmpty(province)){
				province="";
			}
			String status = cmd.getServiceContext().getRequest()
					.getParameter("status");
			if(StringUtils.isEmpty(status)){
				status="";
			}
			
			logger.info("the cmccxingtianyuansms pay notify mobilephone =" + mobile+", id="+linkid);
			
			if("DELIVRD".equals(status)){
				SdkNotifyMmdo sdkNotifyMmdo = new SdkNotifyMmdo();
				sdkNotifyMmdo.setLinkid(linkid);
				sdkNotifyMmdo.setSpnum(spnumber);
				sdkNotifyMmdo.setCmd(momsg);
				sdkNotifyMmdo.setMobile(mobile);
				sdkNotifyMmdo.setKey(province);
				sdkNotifyMmdo.setGameId(246);
				float amount=0;
				if("26C".equals(momsg)){
					amount=1;
				}else if("CA07J".equals(momsg)){
					amount=2;
				}
				sdkNotifyMmdo.setAmount(amount);
				sdkNotifyMmdo.setCreateTime(new Date());
				sdkNotifyMmdo.setOperationType(1);
				sdkNotifyMmdo.setPayChannelCode(payChannelCode);
				sdkNotifyMmdo.setNotifyStatus(1);
				sdkNotifyMmdo.setOriginalcode(status);
				SdkNotifyMmdoMapper sdkNotifyMmdoMapper = dal
						.getMapper(SdkNotifyMmdoMapper.class);
				sdkNotifyMmdoMapper.insertSelective(sdkNotifyMmdo);
				resultMsg="success";
			}else {
				SdkNotifyMmdo sdkNotifyMmdo = new SdkNotifyMmdo();
				sdkNotifyMmdo.setLinkid(linkid);
				sdkNotifyMmdo.setSpnum(spnumber);
				sdkNotifyMmdo.setCmd(momsg);
				sdkNotifyMmdo.setMobile(mobile);
				sdkNotifyMmdo.setKey(province);
				sdkNotifyMmdo.setGameId(246);
				float amount=0;
				if("26C".equals(momsg)){
					amount=1;
				}else if("CA07J".equals(momsg)){
					amount=2;
				}
				sdkNotifyMmdo.setAmount(amount);
				sdkNotifyMmdo.setCreateTime(new Date());
				sdkNotifyMmdo.setOperationType(1);
				sdkNotifyMmdo.setPayChannelCode(payChannelCode);
				sdkNotifyMmdo.setNotifyStatus(0);
				sdkNotifyMmdo.setOriginalcode(status);
				SdkNotifyMmdoMapper sdkNotifyMmdoMapper = dal
						.getMapper(SdkNotifyMmdoMapper.class);
				sdkNotifyMmdoMapper.insertSelective(sdkNotifyMmdo);
				resultMsg="fail";
			}
			dal.commit();
		} catch (Exception e) {
			logger.error("the cmccxingtianyuansms pay notify error!", e);
		} finally {
			dal.close();
		}
		return result(resultMsg);
	}

	private Result result(String mgs) {
		return new Result(new ResultXJContent(mgs, mgs));
	}
}
