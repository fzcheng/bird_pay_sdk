/**
 * 
 */
package com.cheyooh.service.sdk.action.notify;

import java.util.Date;

import com.cheyooh.service.dal.DAL;
import com.cheyooh.service.dal.DALFactory;
import com.cheyooh.service.framework.idata.Result;
import com.cheyooh.service.framework.idata.ResultXJContent;
import com.cheyooh.service.sdk.db.dao.SdkNotifyMmdoMapper;
import com.cheyooh.service.sdk.db.dao.SdkOrderMapper;
import com.cheyooh.service.sdk.db.entity.SdkNotifyMmdo;
import com.cheyooh.service.sdk.db.entity.SdkOrder;
import com.cheyooh.service.sdk.idata.notify.CmdLeyifuPmNotify;

/**
 * @author Merlin
 *
 */
public class LeyifuPmNotify extends AbstractNotifyService<CmdLeyifuPmNotify> {
  private static final Integer CHINA_MOBILE = 1;
  private static final String  LEYIFUPM = "leyifupm";
  
  /* (non-Javadoc)
   * @see com.cheyooh.service.framework.basic.Service#verify(com.cheyooh.service.framework.idata.Cmd)
   */
  @Override
  protected Result verify(CmdLeyifuPmNotify cmd) {
    return null;
  }

  /* (non-Javadoc)
   * @see com.cheyooh.service.framework.basic.Service#execute(com.cheyooh.service.framework.idata.Cmd)
   */
  @Override
  protected Result execute(CmdLeyifuPmNotify cmd) {
    if (!"1".equals(cmd.getFlag())) {
      logger.error("leyifu pm fail, notify = "  + cmd);
      return success();
    }
    DAL dal = DALFactory.createDAL();
    try {
      String orderNo = getOrderNo(cmd.getContent());
      Integer gameId = null;
      if (orderNo != null) {
        SdkOrderMapper orderMapper = dal.getMapper(SdkOrderMapper.class);
        SdkOrder order = orderMapper.selectByPrimaryKey(orderNo);
        if (order != null) {
          gameId = order.getGameId();
        } else {
          logger.error("leyifu pm notify can not found the order, order no = " + orderNo);
        }
      }
      
      SdkNotifyMmdo notifyMmdo = new SdkNotifyMmdo();
      notifyMmdo.setAmount(cmd.getFeecode()/100f);
      notifyMmdo.setCmd(cmd.getContent());
      notifyMmdo.setCreateTime(new Date());
      notifyMmdo.setGameId(gameId);
      notifyMmdo.setKey(cmd.getProvince());
      notifyMmdo.setLinkid(cmd.getLinkid());
      notifyMmdo.setMobile(cmd.getMobile());
      notifyMmdo.setOperationType(CHINA_MOBILE);
      notifyMmdo.setPayChannelCode(LEYIFUPM);
      //notifyMmdo.setSpid(cmd.getLongcode());
      notifyMmdo.setSpnum(cmd.getLongcode());
      SdkNotifyMmdoMapper notifyMmdoDao = dal.getMapper(SdkNotifyMmdoMapper.class);
      notifyMmdoDao.insertSelective(notifyMmdo);
      
      dal.commit();
      return success();
    } catch (Exception e) {
      logger.error("leyifu pm error!", e);
      return fail();
    } finally {
      dal.close();
    }
  }
  
  private String getOrderNo(String content) {
    if (content == null) {
      return null;
    }
    if (content.length() != 17) {
      return null;
    }
    return content.substring(1);
  }
  
  private Result success() {
    return new Result(new ResultXJContent("ok", "ok"));
  }

  private Result fail() {
    // log
    return new Result(new ResultXJContent("error", "error"));
  }
  public static void main(String[] args) {
    System.out.println("Z1409281745400101".substring(1));
  }
}
